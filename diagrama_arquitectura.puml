@startuml DiagramaArquitecturaRehaVR
!theme plain
skinparam classAttributeIconSize 0
skinparam shadowing false
skinparam linetype ortho

title Diagrama de Arquitectura - Sistema RehaVR\nPatrón MVC con Service Layer y Repository

package "Capa de Configuración" {
    class Config {
        +SECRET_KEY: str
        +DEBUG: bool
        +TESTING: bool
        +DATA_PATH: str
        +MYSQL_HOST: str
        +MYSQL_PORT: int
        +CORS_ORIGINS: list
        +SESSION_TYPE: str
        +init_app(app)
    }
    
    class DevelopmentConfig {
        +DEBUG: bool = True
        +LOG_LEVEL: str = "DEBUG"
    }
    
    class ProductionConfig {
        +DEBUG: bool = False
        +LOG_LEVEL: str = "WARNING"
    }
    
    class TestingConfig {
        +TESTING: bool = True
        +DATA_PATH: str
    }
    
    Config <|-- DevelopmentConfig
    Config <|-- ProductionConfig
    Config <|-- TestingConfig
}

package "Capa de Aplicación" {
    class FlaskApp {
        +create_app(config_name): Flask
        +init_extensions(app)
        +setup_logging(app)
        +register_blueprints(app)
        +register_error_handlers(app)
    }
}

package "Capa de Rutas (Blueprints)" {
    class MainBlueprint {
        +index()
        +registro()
        +login()
        +dashboard()
        +ejercicio(nivel)
        +terapia_ocupacional()
        +logout()
    }
    
    class AuthBlueprint {
        +registrar_paciente()
        +iniciar_sesion()
        +cerrar_sesion()
        +obtener_paciente_actual()
        +verificar_sesion()
    }
    
    class EjercicioBlueprint {
        +obtener_ejercicios()
        +obtener_ejercicios_rehabilitacion()
        +obtener_ejercicios_terapia_ocupacional()
        +obtener_ejercicio_por_id(ejercicio_id)
        +registrar_resultado()
        +obtener_historial()
        +obtener_estadisticas_ejercicio(ejercicio_id)
        +obtener_recomendacion()
    }
}

package "Capa de Controladores (MVC)" {
    class AuthController {
        -paciente_service: PacienteService
        +registrar_paciente(): Dict
        +iniciar_sesion(): Dict
        +cerrar_sesion(): Dict
        +obtener_paciente_actual(): Dict
        +verificar_sesion(): Dict
    }
    
    class EjercicioController {
        -ejercicio_service: EjercicioService
        -paciente_service: PacienteService
        +obtener_ejercicios(): Dict
        +obtener_ejercicios_rehabilitacion(): Dict
        +obtener_ejercicios_terapia_ocupacional(): Dict
        +obtener_ejercicio_por_id(ejercicio_id): Dict
        +registrar_resultado(): Dict
        +obtener_historial(): Dict
        +obtener_estadisticas_ejercicio(ejercicio_id): Dict
        +obtener_recomendacion(): Dict
    }
}

package "Capa de Servicios (Service Layer)" {
    class PacienteService {
        -paciente_repo: PacienteRepository
        -ejercicio_repo: EjercicioRepository
        +registrar_paciente(nombre, email, password, edad): Tuple
        +autenticar_paciente(email, password): Tuple
        +obtener_paciente(paciente_id): Paciente
        +obtener_todos_pacientes(): List[Paciente]
        +obtener_estadisticas_paciente(paciente_id): Dict
        +obtener_historial_completo(paciente_id): List[ResultadoEjercicio]
        -_validar_email(email): bool
    }
    
    class EjercicioService {
        -ejercicio_repo: EjercicioRepository
        -_ejercicios_disponibles: List[Ejercicio]
        +obtener_ejercicios_por_tipo(tipo): List[Ejercicio]
        +obtener_ejercicios_por_nivel(nivel): List[Ejercicio]
        +obtener_ejercicio_por_id(ejercicio_id): Ejercicio
        +obtener_todos_ejercicios(): List[Ejercicio]
        +obtener_ejercicios_rehabilitacion(): List[Ejercicio]
        +obtener_ejercicios_terapia_ocupacional(): List[Ejercicio]
        +registrar_resultado(paciente, ejercicio_id, exito, ...): ResultadoEjercicio
        +obtener_estadisticas_ejercicio(paciente_id, ejercicio_id): Dict
        +obtener_recomendacion_ejercicio(paciente_id): Ejercicio
        -_inicializar_ejercicios(): List[Ejercicio]
    }
}

package "Capa de Modelos" {
    class Paciente {
        +nombre: str
        +email: str
        +password: str
        +edad: str
        +id: str
        +fecha_registro: str
        +to_dict(): Dict
        +from_dict(data): Paciente
        +to_dict_safe(): Dict
    }
    
    class Ejercicio {
        +id: str
        +nombre: str
        +descripcion: str
        +tipo: TipoEjercicio
        +nivel: NivelDificultad
        +instrucciones: List[str]
        +parametros: Dict
        +activo: bool
        +to_dict(): Dict
        +from_dict(data): Ejercicio
    }
    
    class ResultadoEjercicio {
        +paciente_id: str
        +tipo_ejercicio: str
        +nivel: int
        +exito: bool
        +fecha: str
        +tiempo_ejecucion: float
        +puntuacion: int
        +observaciones: str
        +to_dict(): Dict
        +from_dict(data): ResultadoEjercicio
    }
    
    enum TipoEjercicio {
        REHABILITACION
        TERAPIA_OCUPACIONAL
    }
    
    enum NivelDificultad {
        PRINCIPIANTE
        INTERMEDIO
        AVANZADO
    }
    
    Ejercicio --> TipoEjercicio
    Ejercicio --> NivelDificultad
    ResultadoEjercicio --> Paciente
}

package "Capa de Repositorios (Repository Pattern)" {
    class PacienteRepository {
        -data_path: str
        -pacientes_file: str
        -historial_path: str
        +get_all(): List[Paciente]
        +save_all(pacientes)
        +add(paciente): bool
        +find_by_email(email): Paciente
        +find_by_credentials(email, password): Paciente
        +get_historial_path(paciente): str
        -_ensure_directories()
    }
    
    class EjercicioRepository {
        -historial_path: str
        +registrar_resultado(paciente_id, ejercicio, exito, ...): ResultadoEjercicio
        +obtener_historial(paciente_id): List[ResultadoEjercicio]
        +obtener_estadisticas(paciente_id): Dict
    }
}

package "Capa de Base de Datos MySQL" {
    class MySQLConnectionManager {
        -config: Dict
        -connection_pool: MySQLConnectionPool
        +get_connection(): Connection
        -_create_connection_pool()
    }
    
    class MySQLDatabaseManager {
        -connection_manager: MySQLConnectionManager
        +_ensure_database_exists()
        +_create_tables()
        +_hash_password(password): str
        +_generate_uuid(): str
    }
    
    class PacienteManager {
        +crear_paciente(nombre, email, password, edad, notas): Dict
        +autenticar_paciente(email, password): Dict
        +obtener_paciente_por_id(paciente_id): Dict
        +obtener_todos_pacientes(): List[Dict]
        +verificar_email_existe(email): bool
    }
    
    class HistorialManager {
        +registrar_ejercicio(paciente_id, nivel_ejercicio, exito, ...): Dict
        +obtener_historial_paciente(paciente_id, limit): List[Dict]
    }
    
    class SesionTerapiaManager {
        +crear_sesion(paciente_id, duracion_minutos, tipo_terapia, observaciones): Dict
        +obtener_sesiones_paciente(paciente_id, limit): List[Dict]
    }
    
    class MySQLDatabaseService {
        +pacientes: PacienteManager
        +historial: HistorialManager
        +sesiones: SesionTerapiaManager
        +test_connection(): bool
        +get_database_info(): Dict
    }
    
    MySQLDatabaseManager <|-- PacienteManager
    MySQLDatabaseManager <|-- HistorialManager
    MySQLDatabaseManager <|-- SesionTerapiaManager
    MySQLDatabaseManager --> MySQLConnectionManager
}

' Relaciones entre capas
FlaskApp --> Config : uses
FlaskApp --> MainBlueprint : registers
FlaskApp --> AuthBlueprint : registers
FlaskApp --> EjercicioBlueprint : registers

MainBlueprint --> AuthController : uses
AuthBlueprint --> AuthController : uses
EjercicioBlueprint --> EjercicioController : uses

AuthController --> PacienteService : uses
EjercicioController --> EjercicioService : uses
EjercicioController --> PacienteService : uses

PacienteService --> PacienteRepository : uses
PacienteService --> EjercicioRepository : uses
EjercicioService --> EjercicioRepository : uses

PacienteRepository --> Paciente : manages
EjercicioRepository --> ResultadoEjercicio : manages
EjercicioRepository --> Ejercicio : references

PacienteManager --> MySQLConnectionManager : uses
HistorialManager --> MySQLConnectionManager : uses
SesionTerapiaManager --> MySQLConnectionManager : uses

note right of FlaskApp
  Factory Pattern
  Crea y configura
  la aplicación Flask
end note

note right of PacienteService
  Service Layer Pattern
  Lógica de negocio
  centralizada
end note

note right of PacienteRepository
  Repository Pattern
  Abstracción del
  acceso a datos
end note

@enduml

