@startuml DiagramaSecuenciaRehaVR
!theme plain
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 60

title Diagrama de Secuencia UML - Flujo de Registro de Paciente\nSistema RehaVR

actor Usuario as user
participant "Frontend\n(Templates)" as frontend
participant "Main Blueprint" as blueprint
participant "Auth Controller" as controller
participant "Paciente Service" as service
participant "Paciente Repository" as repository
database "JSON Files\n/ MySQL" as database

user -> frontend: 1. Accede a /registro
frontend -> blueprint: 2. GET /registro
blueprint -> frontend: 3. Render template
frontend -> user: 4. Muestra formulario

user -> frontend: 5. Completa y envía formulario
frontend -> blueprint: 6. POST /api/auth/registro
blueprint -> controller: 7. registrar_paciente()
activate controller

controller -> controller: 8. Valida datos JSON
controller -> service: 9. registrar_paciente(nombre, email, password, edad)
activate service

service -> service: 10. Valida formato email
service -> service: 11. Valida longitud password
service -> repository: 12. find_by_email(email)
activate repository

repository -> database: 13. Consulta si existe
database -> repository: 14. Retorna resultado
repository -> service: 15. Optional[Paciente]

alt Email no existe
    service -> service: 16. Crea objeto Paciente
    service -> repository: 17. add(paciente)
    repository -> database: 18. Guarda paciente
    database -> repository: 19. Confirmación
    repository -> service: 20. True
    service -> controller: 21. (True, "Registro exitoso", Paciente)
else Email existe
    service -> controller: 21. (False, "Email ya existe", None)
end

controller -> controller: 22. Establece sesión
controller -> blueprint: 23. JSON Response
deactivate controller
blueprint -> frontend: 24. JSON {success: true, paciente: {...}}
frontend -> user: 25. Muestra mensaje de éxito

deactivate service
deactivate repository

note right of service
  **Service Layer**
  Contiene validaciones
  y lógica de negocio
end note

note right of repository
  **Repository Pattern**
  Abstrae el acceso
  a datos
end note

@enduml






